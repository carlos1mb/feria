
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FullRide S.A.S. — MVP Logístico (Vanilla JS)</title>
<style>
  :root{
    --bg:#0e1116; --panel:#151a22; --muted:#9aa4b2; --text:#e7ecf3;
    --brand:#1ABC9C; --brand-2:#2874A6; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
    --card:#11151d; --border:#222a36;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";}
  a{color:var(--brand)}
  .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
  aside{background:linear-gradient(180deg, #121722, #0f131b);padding:18px;border-right:1px solid var(--border);position:sticky;top:0;height:100vh}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:#0a0d12;font-weight:900;box-shadow:var(--shadow)}
  .brand h1{font-size:1.05rem;margin:0;line-height:1.2}
  .subtitle{color:var(--muted);font-size:.8rem;margin-top:2px}
  nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .nav-btn{display:flex;gap:10px;align-items:center;width:100%;padding:10px 12px;background:transparent;border:1px solid transparent;border-radius:12px;color:var(--text);cursor:pointer}
  .nav-btn.active,.nav-btn:hover{background:var(--panel);border-color:var(--border)}
  .nav-btn .dot{width:8px;height:8px;border-radius:999px;background:var(--brand)}
  .sep{height:1px;background:var(--border);margin:14px 0}
  .footer{color:var(--muted);font-size:.75rem;margin-top:auto}
  .main{padding:20px 22px}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .menu-toggle{display:none}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .kpi h3{margin:0 0 10px 0;font-size:.9rem;color:var(--muted)}
  .kpi .value{font-size:1.8rem;font-weight:800}
  .badge{padding:3px 8px;border-radius:999px;font-size:.72rem;border:1px solid var(--border);background:var(--card);color:var(--muted)}
  .ok{background:rgba(34,197,94,.18);border-color:#274936;color:#92f7b2}
  .warn{background:rgba(245,158,11,.18);border-color:#5c4312;color:#ffd89a}
  .danger{background:rgba(239,68,68,.18);border-color:#53202b;color:#ffb0b8}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid var(--border);cursor:pointer;color:var(--muted)}
  .tab.active{background:linear-gradient(135deg,#1ABC9C22,#2874A622);color:var(--text);border-color:#244a5d}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
  .search{flex:1;min-width:220px}
  input,select{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);width:100%}
  label{font-size:.85rem;color:var(--muted)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .col-4{grid-column:span 4}
  .col-3{grid-column:span 3}
  .col-6{grid-column:span 6}
  .col-12{grid-column:span 12}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:0}
  .btn.ghost{background:transparent}
  .btn.danger{background:#4b1f26;border-color:#6e2b34}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:.92rem}
  tbody tr:hover{background:#121723}
  .actions{display:flex;gap:8px}
  .hidden{display:none !important}
  .section{display:none}
  .section.active{display:block}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--border);}
  .note{font-size:.85rem;color:var(--muted)}
  .importer{display:flex;align-items:center;gap:8px}
  .hero{display:flex;gap:14px;align-items:center}
  .hero .mark{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--brand-2),var(--brand));display:grid;place-items:center;font-weight:900;color:#0a0d12}
  /* Mobile */
  @media (max-width: 900px){
    html{font-size:clamp(16px, 3.8vw, 18px)}
    .app{grid-template-columns:1fr}
    .main{padding:16px}
    .card{padding:16px}
    aside{position:fixed;left:0;top:0;transform:translateX(-100%);transition:.25s ease;z-index:20;width:280px}
    aside.open{transform:translateX(0)}
    .menu-toggle{display:inline-flex}
    .kpis{grid-template-columns:1fr}
    .row{grid-template-columns:1fr;gap:10px}
    .toolbar{flex-direction:column;align-items:stretch;gap:10px}
    .search{min-width:0;width:100%}
    .btn{width:100%}
    table{font-size:1rem}
    /* table wrapper scrolling */
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .table-wrap > table{min-width:760px}
  }
</style>
</head>
<body>
<div class="app">
  <aside id="sidebar">
    <div class="brand">
      <div class="logo">FR</div>
      <div>
        <h1>FullRide S.A.S.</h1>
        <div class="subtitle">MVP Logístico — Feria Empresarial</div>
      </div>
    </div>
    <nav>
      <button class="nav-btn active" data-section="dashboard"><span class="dot"></span>Dashboard</button>
      <button class="nav-btn" data-section="pedidos"><span class="dot"></span>Pedidos</button>
      <button class="nav-btn" data-section="clientes"><span class="dot"></span>Clientes</button>
      <button class="nav-btn" data-section="vehiculos"><span class="dot"></span>Vehículos</button>
      <button class="nav-btn" data-section="rutas"><span class="dot"></span>Rutas</button>
      <button class="nav-btn" data-section="reportes"><span class="dot"></span>Reportes & Backups</button>
      <div class="sep"></div>
      <button class="nav-btn" data-section="ayuda"><span class="dot"></span>Ayuda</button>
    </nav>
    <div class="footer">© 2025 FullRide — Demo académica</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="hero">
        <button class="btn ghost menu-toggle" id="menuBtn">☰</button>
        <div class="mark">FR</div>
        <div>
          <div style="font-weight:800">Panel de Gestión Logística</div>
          <div class="note">Sin backend • 100% Vanilla JS • Persistencia localStorage</div>
        </div>
      </div>
      <div class="importer">
        <input type="file" id="importFile" accept=".json" class="hidden">
        <button class="btn" id="importBtn">Importar</button>
        <button class="btn" id="exportBtn">Exportar</button>
        <button class="btn" id="resetBtn" title="Borrar datos locales">Reiniciar</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="kpis">
        <div class="card kpi">
          <h3>Pedidos totales</h3>
          <div class="value" id="kpiTotal">0</div>
          <div class="note">Incluye pendientes, en tránsito y entregados</div>
        </div>
        <div class="card kpi">
          <h3>Entregados</h3>
          <div class="value" id="kpiDone">0</div>
          <span class="badge ok" id="kpiRate">0% éxito</span>
        </div>
        <div class="card kpi">
          <h3>En tránsito</h3>
          <div class="value" id="kpiTransit">0</div>
          <span class="badge warn">monitoreo</span>
        </div>
        <div class="card kpi">
          <h3>Capacidad de flota</h3>
          <div class="value" id="kpiCap">0 kg</div>
          <span class="badge">vehículos activos</span>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="card">
          <div class="tabs">
            <button class="tab active" data-dash="resumen">Resumen</button>
            <button class="tab" data-dash="ultimos">Últimos pedidos</button>
          </div>
          <div id="dash-resumen">
            <p class="note">Este panel resume los indicadores clave definidos en el documento del proyecto: trazabilidad, rutas y administración de flota.</p>
            <ul>
              <li>Órdenes con <span class="pill ok">Entregado</span> = éxito.</li>
              <li>Órdenes <span class="pill warn">En tránsito</span> requieren seguimiento.</li>
              <li>Órdenes <span class="pill danger">Pendiente</span> deben planificarse.</li>
            </ul>
          </div>
          <div id="dash-ultimos" class="hidden table-wrap">
            <table>
              <thead><tr><th>#</th><th>Cliente</th><th>Ruta</th><th>Estado</th><th>Fecha</th></tr></thead>
              <tbody id="dashLast"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- PEDIDOS -->
    <section id="pedidos" class="section">
      <div class="card">
        <div class="toolbar">
          <strong>Gestionar Pedidos</strong>
          <input class="search" id="qPedidos" placeholder="Buscar por cliente, estado o ruta..." />
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-3">
            <label>Cliente</label>
            <select id="pCliente"></select>
          </div>
          <div class="col-3">
            <label>Ruta</label>
            <select id="pRuta"></select>
          </div>
          <div class="col-3">
            <label>Vehículo</label>
            <select id="pVehiculo"></select>
          </div>
          <div class="col-3">
            <label>Estado</label>
            <select id="pEstado">
              <option>Pendiente</option>
              <option>En tránsito</option>
              <option>Entregado</option>
            </select>
          </div>
          <div class="col-3">
            <label>Peso (kg)</label>
            <input type="number" id="pPeso" min="0" step="1" />
          </div>
          <div class="col-3">
            <label>Costo (COP)</label>
            <input type="number" id="pCosto" min="0" step="1000" />
          </div>
          <div class="col-3">
            <label>Fecha</label>
            <input type="date" id="pFecha" />
          </div>
          <div class="col-3" style="align-self:end">
            <button class="btn primary" id="addPedido">Agregar / Guardar</button>
          </div>
          <input type="hidden" id="pId">
        </div>

        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Cliente</th><th>Ruta</th><th>Vehículo</th><th>Peso</th><th>Costo</th><th>Estado</th><th>Fecha</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblPedidos"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="section">
      <div class="card">
        <div class="toolbar">
          <strong>Clientes</strong>
          <input class="search" id="qClientes" placeholder="Buscar por nombre o ciudad..." />
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-4"><label>Nombre</label><input id="cNombre"></div>
          <div class="col-4"><label>Contacto</label><input id="cContacto"></div>
          <div class="col-4"><label>Ciudad</label><input id="cCiudad"></div>
          <input type="hidden" id="cId">
          <div class="col-12"><button class="btn primary" id="addCliente">Agregar / Guardar</button></div>
        </div>
        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead><tr><th>#</th><th>Nombre</th><th>Contacto</th><th>Ciudad</th><th>Acciones</th></tr></thead>
            <tbody id="tblClientes"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VEHÍCULOS -->
    <section id="vehiculos" class="section">
      <div class="card">
        <div class="toolbar">
          <strong>Vehículos</strong>
          <input class="search" id="qVehiculos" placeholder="Buscar por placa o estado..." />
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-4"><label>Placa</label><input id="vPlaca" placeholder="ABC-123"></div>
          <div class="col-4"><label>Capacidad (kg)</label><input type="number" id="vCap" min="0"></div>
          <div class="col-4">
            <label>Estado</label>
            <select id="vEstado"><option>Activo</option><option>Mantenimiento</option><option>Inactivo</option></select>
          </div>
          <input type="hidden" id="vId">
          <div class="col-12"><button class="btn primary" id="addVehiculo">Agregar / Guardar</button></div>
        </div>
        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead><tr><th>#</th><th>Placa</th><th>Capacidad</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="tblVehiculos"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RUTAS -->
    <section id="rutas" class="section">
      <div class="card">
        <div class="toolbar">
          <strong>Rutas</strong>
          <input class="search" id="qRutas" placeholder="Buscar por origen/destino..." />
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-3"><label>Origen</label><input id="rOrigen" placeholder="Corozal"></div>
          <div class="col-3"><label>Destino</label><input id="rDestino" placeholder="Sincelejo"></div>
          <div class="col-3"><label>Distancia (km)</label><input type="number" id="rDist" min="0"></div>
          <div class="col-3"><label>Duración (h)</label><input type="number" id="rDur" min="0" step=".1"></div>
          <input type="hidden" id="rId">
          <div class="col-12"><button class="btn primary" id="addRuta">Agregar / Guardar</button></div>
        </div>
        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead><tr><th>#</th><th>Origen</th><th>Destino</th><th>Distancia</th><th>Duración</th><th>Acciones</th></tr></thead>
            <tbody id="tblRutas"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTES -->
    <section id="reportes" class="section">
      <div class="card">
        <div class="toolbar">
          <strong>Reportes</strong>
          <span class="note">Exporta CSV rápidos o JSON completo</span>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-6">
            <div class="card">
              <h3 style="margin-top:0">Resumen de ventas (COP)</h3>
              <div id="ventasResumen" class="note">Sin datos</div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn" id="csvPedidos">CSV Pedidos</button>
                <button class="btn" id="csvClientes">CSV Clientes</button>
                <button class="btn" id="csvVehiculos">CSV Vehículos</button>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="card">
              <h3 style="margin-top:0">Indicadores de logística</h3>
              <ul id="indicadores"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AYUDA -->
    <section id="ayuda" class="section">
      <div class="card">
        <h3 style="margin-top:0">Ayuda rápida</h3>
        <ul>
          <li>Este MVP está basado en el documento del proyecto (SaaS logístico modular, rutas, flota, trazabilidad).</li>
          <li>Usa <b>localStorage</b>: los datos persisten en este navegador.</li>
          <li>Importa/Exporta en la barra superior para mover datos entre equipos.</li>
          <li>Si todo se ve en blanco, abre el archivo desde un servidor sencillo o revisa que el script esté al final.</li>
        </ul>
      </div>
    </section>

  </main>
</div>

<script>
(function(){
  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  const storeKey = "fullride_mvp_data_v1";
  const today = ()=> new Date().toISOString().slice(0,10);

  const defaultData = {
    clientes:[
      {id:cid(), nombre:"Distribuciones Caribe", contacto:"3170000000", ciudad:"Corozal"},
      {id:cid(), nombre:"Almacén El Éxito", contacto:"3112223344", ciudad:"Sincelejo"},
      {id:cid(), nombre:"Agroinsumos Costa", contacto:"3205557788", ciudad:"Tolú"}
    ],
    vehiculos:[
      {id:vid(), placa:"ZZZ-101", capacidad:1500, estado:"Activo"},
      {id:vid(), placa:"XYZ-909", capacidad:1000, estado:"Mantenimiento"},
      {id:vid(), placa:"AAA-555", capacidad:800, estado:"Activo"}
    ],
    rutas:[
      {id:rid(), origen:"Corozal", destino:"Sincelejo", distancia:14, duracion:0.4},
      {id:rid(), origen:"Corozal", destino:"Sampués", distancia:22, duracion:0.6},
      {id:rid(), origen:"Sincelejo", destino:"Tolú", distancia:24, duracion:0.7}
    ],
    pedidos:[
      {id:pid(), clienteId:1, rutaId:1, vehiculoId:1, peso:120, costo:150000, estado:"Pendiente", fecha:today()},
      {id:pid(), clienteId:2, rutaId:2, vehiculoId:3, peso:300, costo:280000, estado:"En tránsito", fecha:today()},
      {id:pid(), clienteId:3, rutaId:3, vehiculoId:1, peso:90,  costo:90000,  estado:"Entregado", fecha:today()}
    ]
  };

  // ID helpers (simple increment seeded with millis)
  function nextId(prefix){
    const k = "__id_"+prefix;
    let n = Number(localStorage.getItem(k) || "0");
    n = n || Math.floor(Date.now()%10000);
    n += 1;
    localStorage.setItem(k, String(n));
    return n;
  }
  function pid(){ return nextId("p"); }
  function cid(){ return nextId("c"); }
  function vid(){ return nextId("v"); }
  function rid(){ return nextId("r"); }

  let db = load();
  function load(){
    try{
      const raw = localStorage.getItem(storeKey);
      if(!raw){ localStorage.setItem(storeKey, JSON.stringify(defaultData)); return structuredClone(defaultData); }
      return JSON.parse(raw);
    }catch(e){ console.error(e); return structuredClone(defaultData); }
  }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(db)); refreshAll(); }

  // Sidebar + routing
  const sidebar = $("#sidebar");
  $("#menuBtn").addEventListener("click", ()=> sidebar.classList.toggle("open"));
  $$(".nav-btn").forEach(btn=>btn.addEventListener("click", e=>{
    const sec = btn.dataset.section;
    $$(".nav-btn").forEach(b=>b.classList.toggle("active", b===btn));
    $$(".section").forEach(s=>s.classList.toggle("active", s.id===sec));
    if(window.innerWidth<900) sidebar.classList.remove("open");
    refreshAll();
  }));

  // Dashboard tabs
  $$(".tab").forEach(t=>t.addEventListener("click",()=>{
    const name = t.dataset.dash;
    $$(".tab").forEach(x=>x.classList.toggle("active", x===t));
    $("#dash-resumen").classList.toggle("hidden", name!=="resumen");
    $("#dash-ultimos").classList.toggle("hidden", name!=="ultimos");
  }));

  // Populate selects
  function fillSelects(){
    const c = $("#pCliente"); c.innerHTML="";
    db.clientes.forEach((x,i)=> c.append(new Option(x.nombre, x.id)));
    const r = $("#pRuta"); r.innerHTML="";
    db.rutas.forEach((x,i)=> r.append(new Option(`${x.origen} → ${x.destino}`, x.id)));
    const v = $("#pVehiculo"); v.innerHTML="";
    db.vehiculos.forEach((x,i)=> v.append(new Option(`${x.placa} (${x.estado})`, x.id)));
  }

  // Helpers to find by id
  const byId = (arr,id)=> arr.find(x=> String(x.id)===String(id));
  const fmt = n => (Number(n)||0).toLocaleString("es-CO");

  // CRUD — Clientes
  $("#addCliente").addEventListener("click", ()=>{
    const id = $("#cId").value;
    const rec = { id: id? Number(id): cid(), nombre: $("#cNombre").value.trim(), contacto: $("#cContacto").value.trim(), ciudad: $("#cCiudad").value.trim() };
    if(!rec.nombre){ alert("Nombre requerido"); return; }
    if(id){
      const i = db.clientes.findIndex(x=> String(x.id)===id); if(i>-1) db.clientes[i]=rec;
    }else{
      db.clientes.push(rec);
    }
    $("#cId").value=""; $("#cNombre").value=""; $("#cContacto").value=""; $("#cCiudad").value="";
    save();
  });

  function renderClientes(){
    const q = $("#qClientes").value.toLowerCase();
    const tbody = $("#tblClientes"); tbody.innerHTML="";
    db.clientes.filter(x=> [x.nombre,x.ciudad].join(" ").toLowerCase().includes(q)).forEach((x,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${x.nombre}</td><td>${x.contacto||"-"}</td><td>${x.ciudad||"-"}</td>
        <td class="actions">
          <button class="btn" data-edit="${x.id}">Editar</button>
          <button class="btn danger" data-del="${x.id}">Borrar</button>
        </td>`;
      tbody.appendChild(tr);
    });
    // actions
    tbody.querySelectorAll("[data-edit]").forEach(b=> b.onclick = ()=>{
      const id = b.dataset.edit; const it = byId(db.clientes,id);
      $("#cId").value=it.id; $("#cNombre").value=it.nombre; $("#cContacto").value=it.contacto||""; $("#cCiudad").value=it.ciudad||"";
      window.scrollTo({top:0,behavior:"smooth"});
    });
    tbody.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
      const id = Number(b.dataset.del);
      if(confirm("¿Eliminar cliente? También se limpiarán sus pedidos.")){
        db.pedidos = db.pedidos.map(p=> (p.clienteId==id? {...p, clienteId: (db.clientes[0]?.id||0)}:p));
        db.clientes = db.clientes.filter(x=> x.id!==id);
        save();
      }
    });
  }
  $("#qClientes").addEventListener("input", renderClientes);

  // CRUD — Vehículos
  $("#addVehiculo").addEventListener("click", ()=>{
    const id = $("#vId").value;
    const rec = { id: id? Number(id): vid(), placa: $("#vPlaca").value.trim(), capacidad: Number($("#vCap").value||0), estado: $("#vEstado").value };
    if(!rec.placa){ alert("Placa requerida"); return; }
    if(id){
      const i = db.vehiculos.findIndex(x=> String(x.id)===id); if(i>-1) db.vehiculos[i]=rec;
    }else{
      db.vehiculos.push(rec);
    }
    $("#vId").value=""; $("#vPlaca").value=""; $("#vCap").value=""; $("#vEstado").value="Activo";
    save();
  });

  function renderVehiculos(){
    const q = $("#qVehiculos").value.toLowerCase();
    const tbody = $("#tblVehiculos"); tbody.innerHTML="";
    db.vehiculos.filter(x=> [x.placa,x.estado].join(" ").toLowerCase().includes(q)).forEach((x,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${x.placa}</td><td>${fmt(x.capacidad)} kg</td><td>${x.estado}</td>
      <td class="actions">
        <button class="btn" data-edit="${x.id}">Editar</button>
        <button class="btn danger" data-del="${x.id}">Borrar</button>
      </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("[data-edit]").forEach(b=> b.onclick = ()=>{
      const id = b.dataset.edit; const it = byId(db.vehiculos,id);
      $("#vId").value=it.id; $("#vPlaca").value=it.placa; $("#vCap").value=it.capacidad; $("#vEstado").value=it.estado;
      window.scrollTo({top:0,behavior:"smooth"});
    });
    tbody.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
      const id = Number(b.dataset.del);
      if(confirm("¿Eliminar vehículo?")){
        db.pedidos = db.pedidos.map(p=> (p.vehiculoId==id? {...p, vehiculoId: (db.vehiculos[0]?.id||0)}:p));
        db.vehiculos = db.vehiculos.filter(x=> x.id!==id);
        save();
      }
    });
  }
  $("#qVehiculos").addEventListener("input", renderVehiculos);

  // CRUD — Rutas
  $("#addRuta").addEventListener("click", ()=>{
    const id = $("#rId").value;
    const rec = { id: id? Number(id): rid(), origen: $("#rOrigen").value.trim(), destino: $("#rDestino").value.trim(), distancia: Number($("#rDist").value||0), duracion: Number($("#rDur").value||0) };
    if(!rec.origen || !rec.destino){ alert("Origen y destino requeridos"); return; }
    if(id){
      const i = db.rutas.findIndex(x=> String(x.id)===id); if(i>-1) db.rutas[i]=rec;
    }else{
      db.rutas.push(rec);
    }
    $("#rId").value=""; $("#rOrigen").value=""; $("#rDestino").value=""; $("#rDist").value=""; $("#rDur").value="";
    save();
  });

  function renderRutas(){
    const q = $("#qRutas").value.toLowerCase();
    const tbody = $("#tblRutas"); tbody.innerHTML="";
    db.rutas.filter(x=> [x.origen,x.destino].join(" ").toLowerCase().includes(q)).forEach((x,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${x.origen}</td><td>${x.destino}</td><td>${x.distancia} km</td><td>${x.duracion} h</td>
      <td class="actions">
        <button class="btn" data-edit="${x.id}">Editar</button>
        <button class="btn danger" data-del="${x.id}">Borrar</button>
      </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("[data-edit]").forEach(b=> b.onclick = ()=>{
      const id = b.dataset.edit; const it = byId(db.rutas,id);
      $("#rId").value=it.id; $("#rOrigen").value=it.origen; $("#rDestino").value=it.destino; $("#rDist").value=it.distancia; $("#rDur").value=it.duracion;
      window.scrollTo({top:0,behavior:"smooth"});
    });
    tbody.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
      const id = Number(b.dataset.del);
      if(confirm("¿Eliminar ruta?")){
        db.pedidos = db.pedidos.map(p=> (p.rutaId==id? {...p, rutaId: (db.rutas[0]?.id||0)}:p));
        db.rutas = db.rutas.filter(x=> x.id!==id);
        save();
      }
    });
  }
  $("#qRutas").addEventListener("input", renderRutas);

  // CRUD — Pedidos
  $("#addPedido").addEventListener("click", ()=>{
    const id = $("#pId").value;
    const rec = {
      id: id? Number(id): pid(),
      clienteId: Number($("#pCliente").value),
      rutaId: Number($("#pRuta").value),
      vehiculoId: Number($("#pVehiculo").value),
      peso: Number($("#pPeso").value||0),
      costo: Number($("#pCosto").value||0),
      estado: $("#pEstado").value,
      fecha: $("#pFecha").value || today()
    };
    if(id){
      const i = db.pedidos.findIndex(x=> String(x.id)===id); if(i>-1) db.pedidos[i]=rec;
    }else{
      db.pedidos.unshift(rec);
    }
    $("#pId").value=""; $("#pPeso").value=""; $("#pCosto").value=""; $("#pEstado").value="Pendiente"; $("#pFecha").value="";
    save();
  });

  function renderPedidos(){
    fillSelects();
    const q = $("#qPedidos").value.toLowerCase();
    const tbody = $("#tblPedidos"); tbody.innerHTML="";
    db.pedidos.filter(p=>{
      const cliente = byId(db.clientes,p.clienteId)?.nombre||"";
      const ruta = byId(db.rutas,p.rutaId); const rutaTxt = ruta? (ruta.origen+" "+ruta.destino):"";
      return [cliente, p.estado, rutaTxt].join(" ").toLowerCase().includes(q);
    }).forEach((p,i)=>{
      const cliente = byId(db.clientes,p.clienteId)?.nombre||"—";
      const ruta = byId(db.rutas,p.rutaId);
      const veh = byId(db.vehiculos,p.vehiculoId);
      const badge = p.estado==="Entregado"?"ok":(p.estado==="En tránsito"?"warn":"danger");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${cliente}</td>
        <td>${ruta? `${ruta.origen} → ${ruta.destino}`:"—"}</td>
        <td>${veh? veh.placa:"—"}</td>
        <td>${fmt(p.peso)} kg</td>
        <td>$ ${fmt(p.costo)}</td>
        <td><span class="badge ${badge}">${p.estado}</span></td>
        <td>${p.fecha}</td>
        <td class="actions">
          <button class="btn" data-edit="${p.id}">Editar</button>
          <button class="btn danger" data-del="${p.id}">Borrar</button>
        </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("[data-edit]").forEach(b=> b.onclick = ()=>{
      const id = b.dataset.edit; const it = byId(db.pedidos,id);
      $("#pId").value=it.id; $("#pCliente").value=it.clienteId; $("#pRuta").value=it.rutaId; $("#pVehiculo").value=it.vehiculoId;
      $("#pPeso").value=it.peso; $("#pCosto").value=it.costo; $("#pEstado").value=it.estado; $("#pFecha").value=it.fecha;
      window.scrollTo({top:0,behavior:"smooth"});
    });
    tbody.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
      const id = Number(b.dataset.del);
      if(confirm("¿Eliminar pedido?")){
        db.pedidos = db.pedidos.filter(x=> x.id!==id);
        save();
      }
    });
  }
  $("#qPedidos").addEventListener("input", renderPedidos);

  // Export / Import / Reset
  $("#exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "fullride_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
  $("#importFile").addEventListener("change", (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const json = JSON.parse(reader.result);
        if(json.clientes && json.vehiculos && json.pedidos && json.rutas){
          db = json; save();
          alert("Datos importados correctamente");
        }else{
          alert("Archivo inválido");
        }
      }catch(err){ alert("No se pudo leer el archivo"); }
      e.target.value="";
    };
    reader.readAsText(f);
  });
  $("#resetBtn").addEventListener("click", ()=>{
    if(confirm("Esto borrará los datos locales. ¿Continuar?")){
      localStorage.removeItem(storeKey);
      db = structuredClone(defaultData);
      save();
    }
  });

  // Reportes
  function renderReportes(){
    const total = db.pedidos.reduce((s,p)=> s + (Number(p.costo)||0), 0);
    const entreg = db.pedidos.filter(p=>p.estado==="Entregado").length;
    const tot = db.pedidos.length || 1;
    const tasa = Math.round(entreg*100/tot);
    $("#ventasResumen").innerHTML = `<b>Total acumulado:</b> $ ${fmt(total)}<br><span class="note">Entregas exitosas: ${tasa}%</span>`;
    const ind = $("#indicadores"); ind.innerHTML="";
    const enTrans = db.pedidos.filter(p=>p.estado==="En tránsito").length;
    const pend = db.pedidos.filter(p=>p.estado==="Pendiente").length;
    const capActiva = db.vehiculos.filter(v=>v.estado==="Activo").reduce((s,v)=> s + (Number(v.capacidad)||0), 0);
    ;[
      `Pedidos en tránsito: ${enTrans}`,
      `Pedidos pendientes: ${pend}`,
      `Capacidad activa de flota: ${fmt(capActiva)} kg`,
      `Clientes activos: ${db.clientes.length}`
    ].forEach(t=>{
      const li = document.createElement("li"); li.textContent = t; ind.appendChild(li);
    });
  }

  // CSV helpers
  const toCSV = (arr)=>{
    if(!arr.length) return "";
    const cols = Object.keys(arr[0]);
    const esc = v => `"${String(v).replace(/"/g,'""')}"`;
    const lines = [cols.join(",")];
    arr.forEach(o=> lines.push(cols.map(k=> esc(o[k] ?? "")).join(",")));
    return lines.join("\n");
  };
  function downloadCSV(name, rows){
    const blob = new Blob([toCSV(rows)], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; a.click();
    URL.revokeObjectURL(a.href);
  }
  $("#csvPedidos").addEventListener("click", ()=>{
    const rows = db.pedidos.map(p=> ({
      id:p.id, cliente: byId(db.clientes,p.clienteId)?.nombre||"", ruta: (()=>{const r=byId(db.rutas,p.rutaId);return r?`${r.origen}→${r.destino}`:"";})(),
      vehiculo: byId(db.vehiculos,p.vehiculoId)?.placa||"", peso:p.peso, costo:p.costo, estado:p.estado, fecha:p.fecha
    }));
    downloadCSV("pedidos.csv", rows);
  });
  $("#csvClientes").addEventListener("click", ()=> downloadCSV("clientes.csv", db.clientes));
  $("#csvVehiculos").addEventListener("click", ()=> downloadCSV("vehiculos.csv", db.vehiculos));

  // Dashboard render
  function renderDashboard(){
    const tot = db.pedidos.length;
    const done = db.pedidos.filter(p=>p.estado==="Entregado").length;
    const transit = db.pedidos.filter(p=>p.estado==="En tránsito").length;
    const cap = db.vehiculos.filter(v=>v.estado==="Activo").reduce((s,v)=> s + (Number(v.capacidad)||0), 0);
    $("#kpiTotal").textContent = fmt(tot);
    $("#kpiDone").textContent = fmt(done);
    $("#kpiTransit").textContent = fmt(transit);
    $("#kpiCap").textContent = fmt(cap)+" kg";
    $("#kpiRate").textContent = (tot? Math.round(done*100/tot):0)+"% éxito";

    const last = $("#dashLast"); last.innerHTML="";
    db.pedidos.slice(0,6).forEach(p=>{
      const tr = document.createElement("tr");
      const cliente = byId(db.clientes,p.clienteId)?.nombre||"—";
      const ruta = byId(db.rutas,p.rutaId);
      const badge = p.estado==="Entregado"?"ok":(p.estado==="En tránsito"?"warn":"danger");
      tr.innerHTML = `<td>${p.id}</td><td>${cliente}</td><td>${ruta?`${ruta.origen} → ${ruta.destino}`:"—"}</td>
      <td><span class="badge ${badge}">${p.estado}</span></td><td>${p.fecha}</td>`;
      last.appendChild(tr);
    });
  }

  function refreshAll(){
    fillSelects();
    renderDashboard();
    renderPedidos();
    renderClientes();
    renderVehiculos();
    renderRutas();
    renderReportes();
  }

  // Initial mount
  refreshAll();
  // Keyboard shortcuts
  document.addEventListener("keydown", (e)=>{
    if(e.key==="k" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); $("#qPedidos").focus(); }
  });
})();
</script>
</body>
</html>
