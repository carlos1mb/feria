<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduGesti√≥n ‚Äî MVP (Vanilla JS)</title>
  <style>
    :root{
      --bg:#0f172a;/* slate-900 */
      --panel:#111827;/* gray-900 */
      --muted:#1f2937;/* gray-800 */
      --accent:#22d3ee;/* cyan-400 */
      --accent-2:#a78bfa;/* violet-400 */
      --text:#e5e7eb;/* gray-200 */
      --sub:#9ca3af;/* gray-400 */
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --card:#0b1220;
      --radius:16px;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0a0f1c,#0f172a 45%,#0a1224);color:var(--text)}
    a{color:var(--accent)}

    /* Layout */
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{background:linear-gradient(160deg,#0c1222,#0f172a 40%,#0c1120);border-right:1px solid #1f2937;padding:18px;position:sticky;top:0;align-self:start;height:100vh}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{width:40px;height:40px;border-radius:10px;background: radial-gradient(120px 80px at 20% 20%, #22d3ee, transparent 70%), radial-gradient(100px 100px at 80% 70%, #a78bfa, transparent 70%), #0b1220;border:1px solid #1f2937;box-shadow:inset 0 0 0 2px rgba(255,255,255,.03)}
    .brand h1{font-size:18px;margin:0;letter-spacing:.4px}
    .brand small{display:block;color:var(--sub);font-weight:500}

    .nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .nav button{appearance:none;border:none;text-align:left;padding:12px 14px;border-radius:12px;background:#0b1220;color:var(--text);cursor:pointer;border:1px solid #1f2937;transition:.2s;display:flex;align-items:center;gap:10px}
    .nav button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.25)}
    .nav button.active{outline:2px solid var(--accent);background:linear-gradient(180deg,#0e1527,#0b1220)}

    .main{padding:24px}

    /* Topbar */
    .top{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .top .search{flex:1;display:flex;gap:8px}
    .input{background:#0b1220;border:1px solid #1f2937;color:var(--text);padding:10px 12px;border-radius:12px}
    .btn{background:linear-gradient(180deg,#14b8a6,#06b6d4);border:none;color:#001018;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s}
    .btn:hover{filter:brightness(1.1)}
    .btn.secondary{background:#0b1220;color:var(--text);border:1px solid #203047}
    .btn.ghost{background:transparent;border:1px dashed #334155;color:var(--text)}

    /* Cards & grids */
    .cards{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:16px;margin-bottom:18px}
    .card{background:linear-gradient(180deg,#0e1527,#0b1220);border:1px solid #1f2937;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 8px 0;font-size:14px;color:var(--sub)}
    .metric{font-size:28px;font-weight:800;letter-spacing:.2px}
    .trend{margin-top:6px;font-size:12px}
    .trend.up{color:var(--ok)}
    .trend.down{color:var(--bad)}

    /* Panels */
    .panel{background:linear-gradient(180deg,#0d1425,#0b1220);border:1px solid #1f2937;border-radius:var(--radius);padding:16px;margin-bottom:18px;box-shadow:var(--shadow)}
    .panel h2{margin:0 0 12px 0;font-size:18px}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{text-align:left;color:var(--sub);font-size:12px;font-weight:600;padding:0 12px}
    tbody tr{background:#0b1220;border:1px solid #1f2937}
    tbody td{padding:10px 12px;border-top:1px solid #1f2937;border-bottom:1px solid #1f2937}
    tbody tr{border-radius:12px}
    tbody tr td:first-child{border-left:1px solid #1f2937;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-right:1px solid #1f2937;border-top-right-radius:12px;border-bottom-right-radius:12px}

    .tag{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;background:#0b1220}

    /* Forms */
    form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .full{grid-column:1/-1}
    label{display:grid;gap:6px;font-size:12px;color:var(--sub)}
    select, input[type="text"], input[type="number"], input[type="date"], textarea{background:#0b1220;border:1px solid #1f2937;color:var(--text);padding:10px 12px;border-radius:12px}

    /* Pills */
    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .pill{background:#0b1220;border:1px solid #243246;padding:6px 10px;border-radius:999px;font-size:12px;color:var(--sub)}

    /* Footer */
    .footer{margin-top:28px;color:var(--sub);font-size:12px;text-align:center}

    /* Responsive */
    @media (max-width:1100px){
      .cards{grid-template-columns:repeat(2,minmax(200px,1fr))}
      .grid{grid-template-columns:1fr}
      .app{grid-template-columns:100%}
      .sidebar{position:static;height:auto}
    }
    @media (max-width:640px){
      .cards{grid-template-columns:1fr}
      form{grid-template-columns:1fr}
      .nav{flex-direction:row;flex-wrap:wrap}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>EduGesti√≥n <small>MVP ‚Äî Demo</small></h1>
      </div>
    </div>
    <div class="nav" id="nav"></div>
    <div class="footer">Hecho con ‚ù§ en Vanilla JS ‚Äî LocalStorage
      <br/>Demo educativa sin backend
    </div>
  </aside>

  <main class="main">
    <div class="top">
      <div class="search">
        <input id="globalSearch" class="input" placeholder="Buscar en estudiantes, cursos, matr√≠culas‚Ä¶" />
        <button class="btn secondary" id="btnClear">Limpiar</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnSeed">Cargar datos de ejemplo</button>
        <button class="btn" id="btnExport">Exportar JSON</button>
        <label class="btn secondary" style="cursor:pointer;display:inline-block">
          Importar JSON
          <input type="file" id="fileImport" accept="application/json" hidden />
        </label>
      </div>
    </div>

    <section id="view"></section>
  </main>
</div>

<script>
/* ==========================================================
   EduGesti√≥n MVP ‚Äî Vanilla JS + LocalStorage
   M√≥dulos: Dashboard, Estudiantes, Docentes, Cursos, Matr√≠culas,
            Asistencia, Calificaciones, Mensajes, Reportes
   ========================================================== */
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
const uid = (p='id')=> p+"_"+Math.random().toString(36).slice(2,9);

const DB_KEY = 'edugestion_mvp_v1';
const emptyDB = { students:[], teachers:[], courses:[], enrollments:[], attendance:[], grades:[], messages:[] };

const db = {
  data: load(),
  save(){ localStorage.setItem(DB_KEY, JSON.stringify(this.data)); render(); },
  reset(){ this.data = structuredClone(emptyDB); this.save(); }
};
function load(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) || structuredClone(emptyDB) }catch{ return structuredClone(emptyDB)} }

// Routing / Views
const routes = [
  { id:'dashboard', label:'Dashboard', icon:'üìä', render:renderDashboard },
  { id:'students', label:'Estudiantes', icon:'üéì', render:renderStudents },
  { id:'teachers', label:'Docentes', icon:'üë©‚Äçüè´', render:renderTeachers },
  { id:'courses', label:'Cursos', icon:'üìö', render:renderCourses },
  { id:'enrollments', label:'Matr√≠culas', icon:'üßæ', render:renderEnrollments },
  { id:'attendance', label:'Asistencia', icon:'üóìÔ∏è', render:renderAttendance },
  { id:'grades', label:'Calificaciones', icon:'üßÆ', render:renderGrades },
  { id:'messages', label:'Mensajes', icon:'üí¨', render:renderMessages },
  { id:'reports', label:'Reportes', icon:'üìë', render:renderReports },
];

let state = { route:'dashboard', search:'' };

function setRoute(id){ state.route=id; window.location.hash = id; highlightNav(); render(); }
function highlightNav(){ $$('#nav button').forEach(b=>b.classList.toggle('active', b.dataset.id===state.route)); }

function initNav(){
  const nav = $('#nav');
  nav.innerHTML = routes.map(r=>`<button data-id="${r.id}" aria-label="${r.label}">${r.icon} ${r.label}</button>`).join('');
  nav.addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; setRoute(b.dataset.id); });
}

// Global search
$('#globalSearch').addEventListener('input', e=>{ state.search = e.target.value.trim().toLowerCase(); render(); });
$('#btnClear').addEventListener('click', ()=>{ state.search=''; $('#globalSearch').value=''; render(); });

// Export / Import / Seed
$('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(db.data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='edugestion_mvp.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#fileImport').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{ const json=JSON.parse(txt); db.data = Object.assign(structuredClone(emptyDB), json); db.save(); alert('Datos importados ‚úî'); }
  catch{ alert('Archivo inv√°lido'); }
  e.target.value='';
});
$('#btnSeed').addEventListener('click', ()=>{ seed(); db.save(); alert('Datos de ejemplo cargados'); });

// ---------- Render root ----------
function render(){
  const r = routes.find(x=>x.id===state.route) || routes[0];
  $('#view').innerHTML = r.render();
  attachHandlersForCurrentView();
  // Update dashboard numbers in sidebar pills? (Optional)
}

// ---------- Components helpers ----------
function kpiCard(title, value, trend=null){
  const t = trend ? `<div class="trend ${trend>0?'up':'down'}">${trend>0? '‚ñ≤ +'+trend+'%':'‚ñº '+trend+'%'} vs. ant.</div>` : '';
  return `<div class="card"><h3>${title}</h3><div class="metric">${value}</div>${t}</div>`;
}
function table(headers, rows){
  return `<div class="panel">
    <table>
      <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
      <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
    </table>
  </div>`;
}
function pill(text){ return `<span class="pill">${text}</span>`; }

// ---------- DASHBOARD ----------
function renderDashboard(){
  const s = db.data.students.length,
        t = db.data.teachers.length,
        c = db.data.courses.length,
        e = db.data.enrollments.length;
  const attendanceRate = calcAttendanceRate();
  const avgGrade = calcAverageGrade();

  return `
    <div class="cards">
      ${kpiCard('Estudiantes', s)}
      ${kpiCard('Docentes', t)}
      ${kpiCard('Cursos', c)}
      ${kpiCard('Matr√≠culas', e)}
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Resumen acad√©mico</h2>
        <div class="pills">${pill('Asistencia promedio: ' + (attendanceRate*100).toFixed(1) + '%')}${pill('Nota promedio: ' + (isNaN(avgGrade)?'‚Äî':avgGrade.toFixed(1)))}</div>
        ${recentActivity()}
      </div>
      <div class="panel">
        <h2>Acciones r√°pidas</h2>
        <div style="display:grid;gap:8px">
          <button class="btn" data-goto="students">‚ûï Registrar estudiante</button>
          <button class="btn secondary" data-goto="courses">‚ûï Crear curso</button>
          <button class="btn secondary" data-goto="enrollments">‚ûï Nueva matr√≠cula</button>
          <button class="btn secondary" data-goto="grades">‚ûï Registrar calificaci√≥n</button>
        </div>
      </div>
    </div>
  `;
}
function recentActivity(){
  const items = [];
  db.data.enrollments.slice(-5).forEach(x=> items.push({t:'Matr√≠cula', d:x.createdAt}));
  db.data.grades.slice(-5).forEach(x=> items.push({t:'Calificaci√≥n', d:x.createdAt}));
  db.data.attendance.slice(-5).forEach(x=> items.push({t:'Asistencia', d:x.date}));
  items.sort((a,b)=> (b.d||'').localeCompare(a.d||''));
  const rows = items.slice(0,8).map(x=>[`<span class="tag">${x.t}</span>`, new Date(x.d||Date.now()).toLocaleString()]);
  return table(['Evento','Fecha/Hora'], rows.length?rows:[['‚Äî','‚Äî']]);
}
function calcAttendanceRate(){
  const at = db.data.attendance; if(!at.length) return 0;
  const present = at.filter(a=>a.present).length; return present/at.length;
}
function calcAverageGrade(){
  const g = db.data.grades; if(!g.length) return NaN; return g.reduce((s,x)=>s+Number(x.value||0),0)/g.length;
}

// ---------- STUDENTS ----------
function renderStudents(){
  const rows = db.data.students
    .filter(x=> matchSearch([x.firstName,x.lastName,x.document,x.group]))
    .map(s=>[
      `<strong>${s.lastName}, ${s.firstName}</strong><div class="sub" style="color:var(--sub);font-size:12px">Doc: ${s.document} ‚Ä¢ Grupo: ${s.group||'‚Äî'}</div>`,
      `<span class="tag">${s.status||'Activo'}</span>`,
      `<div style="display:flex;gap:8px"><button class="btn secondary" data-edit-stu="${s.id}">Editar</button><button class="btn ghost" data-del-stu="${s.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Estudiantes</h2>
      <form id="formStudent" class="full">
        <label><span>Nombre</span><input required name="firstName" placeholder="Ana"/></label>
        <label><span>Apellido</span><input required name="lastName" placeholder="P√©rez"/></label>
        <label><span>Documento</span><input required name="document" placeholder="123456"/></label>
        <label><span>Grupo/Curso</span><input name="group" placeholder="11-2"/></label>
        <label class="full"><span>Estado</span>
          <select name="status"><option>Activo</option><option>Inactivo</option></select>
        </label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <input type="hidden" name="id" />
          <button class="btn" type="submit">Guardar</button>
          <button class="btn secondary" type="reset" id="resetStudent">Limpiar</button>
        </div>
      </form>
    </div>
    ${table(['Estudiante','Estado','Acciones'], rows)}
  `;
}

// ---------- TEACHERS ----------
function renderTeachers(){
  const rows = db.data.teachers
    .filter(x=> matchSearch([x.firstName,x.lastName,x.document, x.area]))
    .map(t=>[
      `<strong>${t.lastName}, ${t.firstName}</strong><div class="sub" style="color:var(--sub);font-size:12px">Doc: ${t.document} ‚Ä¢ √Årea: ${t.area||'‚Äî'}</div>`,
      `<span class="tag">${t.email||'‚Äî'}</span>`,
      `<div style="display:flex;gap:8px"><button class="btn secondary" data-edit-tea="${t.id}">Editar</button><button class="btn ghost" data-del-tea="${t.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Docentes</h2>
      <form id="formTeacher">
        <label><span>Nombre</span><input required name="firstName"/></label>
        <label><span>Apellido</span><input required name="lastName"/></label>
        <label><span>Documento</span><input required name="document"/></label>
        <label><span>√Årea</span><input name="area" placeholder="Matem√°ticas"/></label>
        <label class="full"><span>Email</span><input type="text" name="email" placeholder="docente@colegio.edu.co"/></label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <input type="hidden" name="id" />
          <button class="btn" type="submit">Guardar</button>
          <button class="btn secondary" type="reset" id="resetTeacher">Limpiar</button>
        </div>
      </form>
    </div>
    ${table(['Docente','Contacto','Acciones'], rows)}
  `;
}

// ---------- COURSES ----------
function renderCourses(){
  const rows = db.data.courses
    .filter(x=> matchSearch([x.name,x.code,x.grade, x.schedule]))
    .map(c=>[
      `<strong>${c.name}</strong><div class="sub" style="color:var(--sub);font-size:12px">C√≥digo: ${c.code} ‚Ä¢ Grado: ${c.grade||'‚Äî'} ‚Ä¢ Docente: ${teacherName(c.teacherId)||'‚Äî'}</div>`,
      `<span class="tag">${c.schedule||'‚Äî'}</span>`,
      `<div style="display:flex;gap:8px"><button class="btn secondary" data-edit-course="${c.id}">Editar</button><button class="btn ghost" data-del-course="${c.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Cursos</h2>
      <form id="formCourse">
        <label><span>Nombre</span><input required name="name" placeholder="Matem√°ticas"/></label>
        <label><span>C√≥digo</span><input required name="code" placeholder="MAT-11"/></label>
        <label><span>Grado</span><input name="grade" placeholder="11"/></label>
        <label><span>Horario</span><input name="schedule" placeholder="Lun-Mi√© 8:00-9:00"/></label>
        <label class="full"><span>Docente</span>
          <select name="teacherId">${options([{id:'',name:'‚Äî Seleccione ‚Äî'}, ...db.data.teachers.map(t=>({id:t.id, name: t.lastName+", "+t.firstName}))])}</select>
        </label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <input type="hidden" name="id" />
          <button class="btn" type="submit">Guardar</button>
          <button class="btn secondary" type="reset" id="resetCourse">Limpiar</button>
        </div>
      </form>
    </div>
    ${table(['Curso','Horario','Acciones'], rows)}
  `;
}

// ---------- ENROLLMENTS ----------
function renderEnrollments(){
  const rows = db.data.enrollments
    .filter(x=> matchSearch([studentName(x.studentId), courseName(x.courseId)]))
    .map(e=>[
      `<div><strong>${studentName(e.studentId)}</strong><div class="sub" style="color:var(--sub);font-size:12px">Curso: ${courseName(e.courseId)}</div></div>`,
      `<span class="tag">${new Date(e.createdAt).toLocaleDateString()}</span>`,
      `<div style="display:flex;gap:8px"><button class="btn secondary" data-del-enr="${e.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Matr√≠culas</h2>
      <form id="formEnroll">
        <label><span>Estudiante</span>
          <select required name="studentId">${options([{id:'',name:'‚Äî Seleccione ‚Äî'}, ...db.data.students.map(s=>({id:s.id,name:s.lastName+", "+s.firstName}))])}</select>
        </label>
        <label><span>Curso</span>
          <select required name="courseId">${options([{id:'',name:'‚Äî Seleccione ‚Äî'}, ...db.data.courses.map(c=>({id:c.id,name:c.name}))])}</select>
        </label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" type="submit">Matricular</button>
        </div>
      </form>
    </div>
    ${table(['Matr√≠cula','Fecha','Acciones'], rows)}
  `;
}

// ---------- ATTENDANCE ----------
function renderAttendance(){
  const rows = db.data.attendance
    .filter(x=> matchSearch([studentName(x.studentId), courseName(x.courseId), x.date]))
    .slice(-200)
    .reverse()
    .map(a=>[
      `<strong>${studentName(a.studentId)}</strong><div class="sub" style="color:var(--sub);font-size:12px">${courseName(a.courseId)}</div>`,
      `<span class="tag">${a.date}</span>`,
      `<span class="tag" style="border-color:${a.present?'#14532d':'#4c1d1d'};color:${a.present?'#22c55e':'#ef4444'}">${a.present?'Presente':'Ausente'}</span>`,
      `<div style="display:flex;gap:8px"><button class="btn secondary" data-del-att="${a.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Asistencia</h2>
      <form id="formAttendance">
        <label><span>Estudiante</span>
          <select required name="studentId">${options(db.data.students.map(s=>({id:s.id,name:s.lastName+", "+s.firstName})))}</select>
        </label>
        <label><span>Curso</span>
          <select required name="courseId">${options(db.data.courses.map(c=>({id:c.id,name:c.name})) )}</select>
        </label>
        <label><span>Fecha</span><input type="date" required name="date" value="${nowDate()}"/></label>
        <label><span>Estado</span>
          <select name="present">
            <option value="true">Presente</option>
            <option value="false">Ausente</option>
          </select>
        </label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" type="submit">Registrar</button>
        </div>
      </form>
    </div>
    ${table(['Estudiante','Fecha','Asistencia','Acciones'], rows)}
  `;
}

// ---------- GRADES ----------
function renderGrades(){
  const rows = db.data.grades
    .filter(x=> matchSearch([studentName(x.studentId), courseName(x.courseId), x.assessment]))
    .slice(-200)
    .reverse()
    .map(g=>[
      `<div><strong>${studentName(g.studentId)}</strong><div class="sub" style="color:var(--sub);font-size:12px">${courseName(g.courseId)} ‚Ä¢ ${g.assessment||'Actividad'}</div></div>`,
      `<span class="tag">${Number(g.value).toFixed(1)}</span>`,
      `<div style="display:flex;gap:8px"><button class="btn secondary" data-edit-grade="${g.id}">Editar</button><button class="btn ghost" data-del-grade="${g.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Calificaciones</h2>
      <form id="formGrade">
        <label><span>Estudiante</span>
          <select required name="studentId">${options(db.data.students.map(s=>({id:s.id,name:s.lastName+", "+s.firstName})))}</select>
        </label>
        <label><span>Curso</span>
          <select required name="courseId">${options(db.data.courses.map(c=>({id:c.id,name:c.name})) )}</select>
        </label>
        <label><span>Evidencia/Actividad</span><input name="assessment" placeholder="Parcial 1"/></label>
        <label><span>Nota (0.0 ‚Äì 5.0)</span><input type="number" step="0.1" min="0" max="5" required name="value" placeholder="4.5"/></label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <input type="hidden" name="id" />
          <button class="btn" type="submit">Guardar</button>
          <button class="btn secondary" type="reset" id="resetGrade">Limpiar</button>
        </div>
      </form>
    </div>
    ${table(['Estudiante / Curso','Nota','Acciones'], rows)}
  `;
}

// ---------- MESSAGES (Comunicaci√≥n institucional) ----------
function renderMessages(){
  const rows = db.data.messages
    .filter(x=> matchSearch([x.title,x.body, x.toRole]))
    .slice(-100)
    .reverse()
    .map(m=>[
      `<strong>${m.title}</strong><div class="sub" style="color:var(--sub);font-size:12px">Para: ${m.toRole} ‚Ä¢ ${new Date(m.createdAt).toLocaleString()}</div>`,
      `<div style="max-width:520px">${escapeHtml(m.body)}</div>`,
      `<div style="display:flex;gap:8px"><button class="btn ghost" data-del-msg="${m.id}">Eliminar</button></div>`
    ]);

  return `
    <div class="panel">
      <h2>Mensajes</h2>
      <form id="formMessage">
        <label><span>T√≠tulo</span><input required name="title" placeholder="Reuni√≥n de padres"/></label>
        <label><span>Para</span>
          <select name="toRole">
            <option value="Todos">Todos</option>
            <option value="Docentes">Docentes</option>
            <option value="Estudiantes">Estudiantes</option>
            <option value="Familias">Familias</option>
          </select>
        </label>
        <label class="full"><span>Mensaje</span><textarea name="body" rows="3" placeholder="Texto del comunicado‚Ä¶"></textarea></label>
        <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" type="submit">Publicar</button>
        </div>
      </form>
    </div>
    ${table(['Mensaje','Contenido','Acciones'], rows)}
  `;
}

// ---------- REPORTS ----------
function renderReports(){
  // Simple report: promedio por curso y asistencia por curso
  const perCourse = db.data.courses.map(c=>{
    const enrIds = db.data.enrollments.filter(e=>e.courseId===c.id).map(e=>e.studentId);
    const g = db.data.grades.filter(x=>x.courseId===c.id && enrIds.includes(x.studentId));
    const avg = g.length? (g.reduce((s,x)=>s+Number(x.value||0),0)/g.length) : NaN;
    const at = db.data.attendance.filter(a=>a.courseId===c.id && enrIds.includes(a.studentId));
    const rate = at.length? (at.filter(a=>a.present).length/at.length) : NaN;
    return { course:c.name, teacher: teacherName(c.teacherId)||'‚Äî', avg, rate, count: enrIds.length };
  });

  const rows = perCourse.map(r=>[
    `<strong>${r.course}</strong><div class="sub" style="color:var(--sub);font-size:12px">Docente: ${r.teacher}</div>`,
    r.count,
    isNaN(r.avg)?'‚Äî':Number(r.avg).toFixed(2),
    isNaN(r.rate)?'‚Äî':(r.rate*100).toFixed(1)+'%'
  ]);

  const htmlTable = table(['Curso','Matr√≠culas','Promedio','Asistencia'], rows);

  return `
    <div class="panel">
      <h2>Reportes</h2>
      <div class="pills">${pill('Descarga r√°pida de json desde la barra superior')}${pill('Tabla imprimible')}</div>
      ${htmlTable}
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn secondary" id="btnPrint">Imprimir</button>
      </div>
    </div>
  `;
}

// ---------- Utilities ----------
function attachHandlersForCurrentView(){
  const id = state.route;
  if(id==='dashboard'){
    $$('.panel .btn').forEach(b=> b.dataset.goto && (b.onclick = ()=> setRoute(b.dataset.goto)) );
  }
  if(id==='students') attachStudentHandlers();
  if(id==='teachers') attachTeacherHandlers();
  if(id==='courses') attachCourseHandlers();
  if(id==='enrollments') attachEnrollmentHandlers();
  if(id==='attendance') attachAttendanceHandlers();
  if(id==='grades') attachGradeHandlers();
  if(id==='messages') attachMessageHandlers();
  if(id==='reports') $('#btnPrint')?.addEventListener('click', ()=> window.print());
}

function attachStudentHandlers(){
  const f = $('#formStudent');
  f.onsubmit = (e)=>{ e.preventDefault(); const fd = Object.fromEntries(new FormData(f));
    if(fd.id){
      const i = db.data.students.findIndex(x=>x.id===fd.id); if(i>-1) db.data.students[i] = {...db.data.students[i], ...fd};
    }else{
      db.data.students.push({ id: uid('stu'), firstName: fd.firstName, lastName: fd.lastName, document: fd.document, group: fd.group, status: fd.status||'Activo', createdAt: new Date().toISOString()});
    }
    f.reset(); db.save();
  };
  $('#resetStudent').onclick = ()=> f.reset();
  $('#view').addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del-stu]');
    const edit = e.target.closest('[data-edit-stu]');
    if(del){ if(confirm('¬øEliminar estudiante?')){ db.data.students = db.data.students.filter(x=>x.id!==del.dataset.delStu); db.save(); } }
    if(edit){ const s = db.data.students.find(x=>x.id===edit.dataset.editStu); if(s){ Object.entries(s).forEach(([k,v])=>{ if(f[k]!==undefined) f[k].value = v; }); } }
  });
}

function attachTeacherHandlers(){
  const f = $('#formTeacher');
  f.onsubmit = (e)=>{ e.preventDefault(); const fd = Object.fromEntries(new FormData(f));
    if(fd.id){ const i = db.data.teachers.findIndex(x=>x.id===fd.id); if(i>-1) db.data.teachers[i] = {...db.data.teachers[i], ...fd}; }
    else{ db.data.teachers.push({ id: uid('tea'), firstName: fd.firstName, lastName: fd.lastName, document: fd.document, area: fd.area||'', email: fd.email||'', createdAt:new Date().toISOString() }); }
    f.reset(); db.save();
  };
  $('#resetTeacher').onclick = ()=> f.reset();
  $('#view').addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del-tea]');
    const edit = e.target.closest('[data-edit-tea]');
    if(del){ if(confirm('¬øEliminar docente?')){ db.data.teachers = db.data.teachers.filter(x=>x.id!==del.dataset.delTea); db.save(); } }
    if(edit){ const t = db.data.teachers.find(x=>x.id===edit.dataset.editTea); if(t){ Object.entries(t).forEach(([k,v])=>{ if(f[k]!==undefined) f[k].value = v; }); } }
  });
}

function attachCourseHandlers(){
  const f = $('#formCourse');
  f.onsubmit = (e)=>{ e.preventDefault(); const fd = Object.fromEntries(new FormData(f));
    if(fd.id){ const i = db.data.courses.findIndex(x=>x.id===fd.id); if(i>-1) db.data.courses[i] = {...db.data.courses[i], ...fd}; }
    else{ db.data.courses.push({ id: uid('cou'), name: fd.name, code: fd.code, grade: fd.grade||'', schedule: fd.schedule||'', teacherId: fd.teacherId||'', createdAt:new Date().toISOString() }); }
    f.reset(); db.save();
  };
  $('#resetCourse').onclick = ()=> f.reset();
  $('#view').addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del-course]');
    const edit = e.target.closest('[data-edit-course]');
    if(del){ if(confirm('¬øEliminar curso?')){ db.data.courses = db.data.courses.filter(x=>x.id!==del.dataset.delCourse); db.save(); } }
    if(edit){ const c = db.data.courses.find(x=>x.id===edit.dataset.editCourse); if(c){ Object.entries(c).forEach(([k,v])=>{ if(f[k]!==undefined) f[k].value = v; }); } }
  });
}

function attachEnrollmentHandlers(){
  const f=$('#formEnroll');
  f.onsubmit=(e)=>{ e.preventDefault(); const fd=Object.fromEntries(new FormData(f));
    const exists = db.data.enrollments.find(x=> x.studentId===fd.studentId && x.courseId===fd.courseId);
    if(exists) return alert('Ya existe esta matr√≠cula');
    db.data.enrollments.push({ id: uid('enr'), studentId: fd.studentId, courseId: fd.courseId, createdAt: new Date().toISOString() });
    db.save(); f.reset();
  };
  $('#view').addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del-enr]'); if(del){ if(confirm('¬øEliminar matr√≠cula?')){ db.data.enrollments = db.data.enrollments.filter(x=>x.id!==del.dataset.delEnr); db.save(); } }
  });
}

function attachAttendanceHandlers(){
  const f=$('#formAttendance');
  f.onsubmit=(e)=>{ e.preventDefault(); const fd=Object.fromEntries(new FormData(f));
    db.data.attendance.push({ id: uid('att'), studentId: fd.studentId, courseId: fd.courseId, date: fd.date, present: fd.present==='true', createdAt: new Date().toISOString() });
    db.save(); f.reset(); f.date.value = nowDate();
  };
  $('#view').addEventListener('click', (e)=>{
    const del=e.target.closest('[data-del-att]'); if(del){ if(confirm('¬øEliminar registro de asistencia?')){ db.data.attendance = db.data.attendance.filter(x=>x.id!==del.dataset.delAtt); db.save(); } }
  });
}

function attachGradeHandlers(){
  const f=$('#formGrade');
  f.onsubmit=(e)=>{ e.preventDefault(); const fd=Object.fromEntries(new FormData(f));
    if(fd.id){ const i = db.data.grades.findIndex(x=>x.id===fd.id); if(i>-1) db.data.grades[i] = {...db.data.grades[i], studentId:fd.studentId, courseId:fd.courseId, assessment:fd.assessment||'', value:Number(fd.value)}; }
    else { db.data.grades.push({ id: uid('gra'), studentId:fd.studentId, courseId:fd.courseId, assessment:fd.assessment||'', value: Number(fd.value), createdAt:new Date().toISOString() }); }
    db.save(); f.reset();
  };
  $('#resetGrade').onclick = ()=> f.reset();
  $('#view').addEventListener('click', (e)=>{
    const del=e.target.closest('[data-del-grade]');
    const edit=e.target.closest('[data-edit-grade]');
    if(del){ if(confirm('¬øEliminar calificaci√≥n?')){ db.data.grades = db.data.grades.filter(x=>x.id!==del.dataset.delGrade); db.save(); } }
    if(edit){ const g = db.data.grades.find(x=>x.id===edit.dataset.editGrade); const f=$('#formGrade'); if(g){ Object.entries(g).forEach(([k,v])=>{ if(f[k]!==undefined) f[k].value = v; }); f.value.value = Number(g.value).toFixed(1); } }
  });
}

function attachMessageHandlers(){
  const f=$('#formMessage');
  f.onsubmit=(e)=>{ e.preventDefault(); const fd=Object.fromEntries(new FormData(f));
    db.data.messages.push({ id: uid('msg'), title: fd.title, toRole: fd.toRole, body: fd.body||'', createdAt: new Date().toISOString() });
    db.save(); f.reset();
  };
  $('#view').addEventListener('click', (e)=>{ const del = e.target.closest('[data-del-msg]'); if(del){ if(confirm('¬øEliminar mensaje?')){ db.data.messages = db.data.messages.filter(x=>x.id!==del.dataset.delMsg); db.save(); } } });
}

// Helpers
function options(arr){ return arr.map(o=>`<option value="${o.id}">${escapeHtml(o.name)}</option>`).join(''); }
function studentName(id){ const s = db.data.students.find(x=>x.id===id); return s? `${s.lastName}, ${s.firstName}` : '‚Äî'; }
function teacherName(id){ const t = db.data.teachers.find(x=>x.id===id); return t? `${t.lastName}, ${t.firstName}` : null; }
function courseName(id){ const c = db.data.courses.find(x=>x.id===id); return c? c.name : '‚Äî'; }
function nowDate(){ return new Date().toISOString().slice(0,10); }
function matchSearch(fields){ if(!state.search) return true; return fields.some(v=> (v||'').toString().toLowerCase().includes(state.search)); }
function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]) ); }

// Seed example data
function seed(){
  db.data = structuredClone(emptyDB);
  const stus = [
    ['Ana','P√©rez','101','11-1'],
    ['Luis','G√≥mez','102','11-1'],
    ['Mar√≠a','Rodr√≠guez','103','11-2'],
    ['Juan','Mart√≠nez','104','10-3']
  ].map(([fn,ln,doc,grp])=>({id:uid('stu'),firstName:fn,lastName:ln,document:doc,group:grp,status:'Activo',createdAt:new Date().toISOString()}));
  const teas = [
    ['Laura','Torres','900','Matem√°ticas','laura@colegio.edu'],
    ['Carlos','Rivas','901','Lengua','carlos@colegio.edu']
  ].map(([fn,ln,doc,area,email])=>({id:uid('tea'),firstName:fn,lastName:ln,document:doc,area,email,createdAt:new Date().toISOString()}));
  const cours = [
    ['Matem√°ticas 11','MAT-11','11','Lun-Mi√© 8:00', null],
    ['Lengua 11','LEN-11','11','Mar-Jue 9:00', null]
  ].map(([name,code,grade,schedule])=>({id:uid('cou'),name,code,grade,schedule,teacherId:'',createdAt:new Date().toISOString()}));
  // assign teachers
  cours[0].teacherId = teas[0].id; cours[1].teacherId = teas[1].id;

  db.data.students.push(...stus);
  db.data.teachers.push(...teas);
  db.data.courses.push(...cours);

  // Enroll first 3 students in course 0 and 1
  [stus[0].id, stus[1].id, stus[2].id].forEach(sid=>{
    db.data.enrollments.push({id:uid('enr'), studentId:sid, courseId:cours[0].id, createdAt:new Date().toISOString()});
    db.data.enrollments.push({id:uid('enr'), studentId:sid, courseId:cours[1].id, createdAt:new Date().toISOString()});
  });
  // Attendance sample
  db.data.enrollments.forEach(e=>{
    for(let d=1; d<=5; d++){
      db.data.attendance.push({ id:uid('att'), studentId:e.studentId, courseId:e.courseId, date:`2025-10-0${Math.min(d,9)}`, present: Math.random()>0.15, createdAt:new Date().toISOString() });
    }
  });
  // Grades sample
  const assessments=['Parcial 1','Taller','Quiz'];
  db.data.enrollments.forEach(e=>{
    assessments.forEach(a=> db.data.grades.push({ id:uid('gra'), studentId:e.studentId, courseId:e.courseId, assessment:a, value:(Math.random()*2)+3, createdAt:new Date().toISOString() }));
  });
  // Messages
  db.data.messages.push({ id:uid('msg'), title:'Bienvenida a la plataforma', toRole:'Todos', body:'Recordatorio: mantener datos actualizados.', createdAt:new Date().toISOString() });
}

// Boot
function boot(){
  initNav();
  state.route = (location.hash.replace('#','')) || 'dashboard';
  highlightNav();
  render();
}
window.addEventListener('hashchange', ()=>{ state.route = location.hash.replace('#','')||'dashboard'; highlightNav(); render(); });
boot();
</script>
</body>
</html>
